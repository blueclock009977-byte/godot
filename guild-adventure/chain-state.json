{
  "taskId": "ga-refactor-2026-02-27",
  "goal": "Guild Adventureのソロ/マルチ処理を共通化・リファクタリング",
  "completionCriteria": [
    "重複コードが統合されている",
    "TypeScriptエラーがない",
    "chain-state.jsonのlogに変更履歴がある"
  ],
  "judgmentCriteria": [
    "1. 既存機能が壊れない",
    "2. コードの可読性向上",
    "3. 変更量は最小限",
    "4. ソロ/マルチで仕様が異なる場合は相談"
  ],
  "constraints": [
    "1cronで1タスクのみ",
    "ソロ/マルチで仕様が異なる場合はパパに相談"
  ],
  "currentPhase": 2,
  "phaseAttempt": 10,
  "maxAttempts": 30,
  "startedAt": "2026-02-27T04:44:00Z",
  "discordChannel": "channel:1471429991005950013",
  "assumptions": [],
  "log": [
    {
      "time": "2026-02-27T04:46:00Z",
      "action": "refactor",
      "file": "src/app/friends/page.tsx",
      "detail": "getDungeonName()とcalculateRemainingMinutes()ヘルパー関数を抽出、getStatusDisplay内の重複コードを削減"
    },
    {
      "time": "2026-02-27T04:49:00Z",
      "action": "refactor",
      "file": "src/lib/utils/status.ts",
      "detail": "getStatusDisplay()を共通ヘルパーに抽出。friends/page.tsxとmulti/[code]/page.tsxの重複を解消"
    },
    {
      "time": "2026-02-27T04:54:00Z",
      "action": "refactor",
      "file": "src/components/multi/InviteModal.tsx",
      "detail": "フレンド招待モーダルを別コンポーネントに抽出。multi/[code]/page.tsx: 791行→715行（-76行）"
    },
    {
      "time": "2026-02-27T05:01:00Z",
      "action": "refactor",
      "file": "src/components/multi/BattleResultView.tsx",
      "detail": "結果画面UIを別コンポーネントに抽出。multi/[code]/page.tsx: 715行→675行（-40行）"
    },
    {
      "time": "2026-02-27T05:04:00Z",
      "action": "refactor",
      "file": "src/components/multi/BattleProgressView.tsx",
      "detail": "バトル進行UI（プログレスバー+ログ表示）を別コンポーネントに抽出。multi/[code]/page.tsx: 675行→630行（-45行）"
    },
    {
      "time": "2026-02-27T05:08:00Z",
      "action": "refactor",
      "file": "src/components/multi/CharacterSelectPanel.tsx",
      "detail": "キャラ選択UI（選択中表示+キャラ一覧）を別コンポーネントに抽出。multi/[code]/page.tsx: 630行→573行（-57行）"
    },
    {
      "time": "2026-02-27T05:12:00Z",
      "action": "refactor",
      "file": "src/store/gameStore.ts",
      "detail": "restoreAdventureをヘルパー関数に分離: restoreMultiAdventureHelper + restoreSoloAdventureHelper。restoreAdventure本体が90行→30行に削減"
    },
    {
      "time": "2026-02-27T05:18:00Z",
      "action": "refactor",
      "file": "src/components/multi/WaitingRoomView.tsx",
      "detail": "待機中UI（ヘッダー+プレイヤー一覧+キャラ選択+準備完了ボタン）を別コンポーネントに抽出。multi/[code]/page.tsx: 532行→469行（-63行）"
    },
    {
      "time": "2026-02-27T05:23:00Z",
      "action": "refactor",
      "file": "src/lib/multi/battleStarter.ts",
      "detail": "startMultiBattleヘルパーを新規作成。パーティ構築、バトル実行、ドロップ計算、Firebase保存を抽出。multi/[code]/page.tsx: 469行→401行（-68行）"
    },
    {
      "time": "2026-02-27T05:27:00Z",
      "action": "refactor",
      "file": "src/hooks/useBattleProgress.ts",
      "detail": "バトルログ表示関連のuseEffect2つをカスタムフックに抽出。multi/[code]/page.tsx: 401行→334行（-67行）"
    }
  ],
  "findings": [
    "multi/[code]/page.tsx が334行まで削減済み"
  ],
  "completed": [
    "friends/page.tsx: getDungeonName, calculateRemainingMinutes ヘルパー抽出",
    "lib/utils/status.ts: getStatusDisplay共通化（friends + multi両方で使用）",
    "components/multi/InviteModal.tsx: フレンド招待モーダルを抽出",
    "components/multi/BattleResultView.tsx: 結果画面UIを抽出",
    "components/multi/BattleProgressView.tsx: バトル進行UIを抽出",
    "components/multi/CharacterSelectPanel.tsx: キャラ選択UIを抽出",
    "store/gameStore.ts: restoreAdventureをヘルパー関数に分離",
    "components/multi/WaitingRoomView.tsx: 待機中UIを抽出",
    "lib/multi/battleStarter.ts: startMultiBattleヘルパーを新規作成",
    "hooks/useBattleProgress.ts: バトルログ表示のuseEffectをカスタムフックに抽出"
  ]
}
