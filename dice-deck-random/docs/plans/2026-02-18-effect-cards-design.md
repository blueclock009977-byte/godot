# 効果カード設計ドキュメント

## 基礎予算式
- `Budget = 12 + 8 * cost`
- ドロー: 1枚あたり -12

## 設計原則
- 効果テキストは effect_manager.gd に一元管理
- 効果量は card_database.gd の modifier で調整
- 全効果IDをカバー

## 調整記録

### 2026-02-20 チェーン式検証開始
- v1.1.46時点: 基礎予算12+8cost、過剰効果弱体化済み
- オンライン対戦: v1.1.43でスロット同期・ターン重複処理修正済み

### 2026-02-20 16:07 シミュレーター実行 (Phase 3)
**テスト結果:** 482テスト全パス

**色別勝率（100ゲーム×21マッチアップ）:**
| 色 | 勝率 | 勝/試合 |
|---|---:|---:|
| BLUE | 6.8% | 81/1200 |
| GREEN | 8.8% | 105/1200 |
| BLACK | 12.2% | 146/1200 |
| RED | 6.3% | 76/1200 |
| YELLOW | 6.6% | 79/1200 |
| PURPLE | 7.0% | 84/1200 |
| WHITE | 6.7% | 80/1200 |

**バランス指標:**
- 色勝率差: 5.8% ✓（目標15%以内）
- 先攻有利: +11.8% ✗（目標8%以内）
- 平均ターン: 44-49

**問題発見:**
1. 勝率が6-12%と異常に低い → ほぼ全ゲームがドローで終了
2. 平均ターンが50近い → 上限到達でドロー判定
3. シミュレーターのダメージ処理に問題がある可能性

**次のアクション:**
- シミュレーターのバトルロジックを検証・修正
- ダメージがプレイヤーHPに正しく反映されているか確認

### 2026-02-20 16:15 シミュレーター修正 (Phase 3.1)
**修正内容:**
1. `duplicate(true)` を削除 → カードHPがバトル後に反映されるように
2. カードへの攻撃時のプレイヤーHP加算を削除 → 直接攻撃のみプレイヤーHPに反映

**修正後の結果:**
| 色 | 勝率 |
|---|---:|
| BLUE | 7.6% |
| GREEN | 5.5% |
| BLACK | 13.0% |
| RED | 5.8% |
| YELLOW | 7.2% |
| PURPLE | 7.6% |
| WHITE | 7.3% |

- 色勝率差: 7.5% ✓
- 先攻有利: +11.2% ✗

**残存問題:**
- 勝率5-13%と低すぎ = ドローが多発
- 平均ターン44-49 = 50ターン上限で決着なし
- シミュレーターのターン進行orマナ計算に問題がある可能性

### 2026-02-20 16:15 シミュレーター修正完了 (Phase 4)

**根本原因特定:**
`_simulate_game`内で参照変数（cur_hand, cur_mana）を使用していたが、ターン交代後に条件判定していたため、値の更新が逆転していた。

**修正内容:**
- 参照変数方式を廃止
- 各プレイヤーの手札/マナ/フィールドを直接操作に変更
- ターン判定で分岐して処理

**修正後の結果:**
| 色 | 勝率 | 勝/試合 |
|---|---:|---:|
| BLUE | 47.2% | 566/1200 |
| GREEN | 55.5% | 666/1200 |
| **BLACK** | **71.2%** | 854/1200 |
| RED | 48.0% | 576/1200 |
| YELLOW | 44.0% | 528/1200 |
| PURPLE | 44.2% | 531/1200 |
| **WHITE** | **37.0%** | 444/1200 |

**バランス指標:**
- 色勝率差: 34.2% ✗（目標15%以内）
- 先攻有利: +11.3% ✗（目標8%以内）
- **平均ターン: 20-24 ✓**（正常範囲）

**分析:**
- シミュレーターは正常動作！ゲームが適切に終了するようになった
- **BLACK（黒）が圧倒的に強い** - 71.2%勝率
- **WHITE（白）が弱い** - 37.0%勝率
- 先攻有利が高めなのはゲーム性として許容範囲か要検討

**次のアクション:**
1. 黒カードのステータス確認・弱体化
2. 白カードのステータス確認・強化
3. 再シミュレーションで収束確認

### 2026-02-20 16:20 シミュレーター再実行 (Phase 6)

**調整内容（軽微）:**
- `card_database.gd` に色別の予算微調整を追加
  - GREEN: `-2`（軽微弱体化）
  - BLACK: `-2`（軽微弱体化）
  - PURPLE: `+2`（軽微強化）
- 実装箇所: `_get_color_balance_budget_adjustment()` を追加し、`_balance_effect_card_stats()` の予算計算に反映

**シミュレーター結果（100ゲーム×21マッチアップ）:**
| 色 | 勝率 | 勝/試合 |
|---|---:|---:|
| BLUE | 47.6% | 571/1200 |
| GREEN | 44.2% | 530/1200 |
| BLACK | 59.0% | 708/1200 |
| RED | 47.9% | 575/1200 |
| YELLOW | 48.2% | 578/1200 |
| PURPLE | 53.9% | 647/1200 |
| WHITE | 47.6% | 571/1200 |

**バランス指標:**
- 色勝率差: 14.8% ✓（目標15%以内を達成）
- 先攻有利: +13.4% ✗（目標±8%未達）

**評価:**
- Phase 5時点（BLACK 61.5%, PURPLE 41.2%）から改善
  - BLACK: 61.5% → 59.0%（抑制）
  - PURPLE: 41.2% → 53.9%（改善）
- ただし先攻有利は依然として高く、次Phaseでは先後差専用の調整が必要

### 2026-02-20 16:23 シミュレーター再実行 (Phase 7)

**先後補正案（実装）:**
- `test_balance_simulator.gd` に `SECOND_PLAYER_STARTING_MANA_BONUS := 1` を追加
- 後攻（`mana_o`）の初期マナを `STARTING_MANA + 1` に変更
- 狙い: 先攻のテンポ優位を軽減

**シミュレーター結果（100ゲーム×21マッチアップ）:**
| 色 | 勝率 | 勝/試合 |
|---|---:|---:|
| BLUE | 47.8% | 574/1200 |
| GREEN | 44.2% | 530/1200 |
| BLACK | 60.2% | 723/1200 |
| RED | 48.5% | 582/1200 |
| YELLOW | 48.7% | 584/1200 |
| PURPLE | 52.1% | 625/1200 |
| WHITE | 46.2% | 555/1200 |

**バランス指標:**
- 色勝率差: 16.1% ✗（目標15%以内をわずかに超過）
- 平均先攻有利: -10.5% ✗（後攻有利へ反転、目標±8%未達）

**評価:**
- Phase 6（+13.4%）→ Phase 7（-10.5%）で、補正が強すぎて逆方向にオーバーシュート
- 後攻初期マナ+1は「軽微」だが実効影響は大きい
- 次Phaseでは補正を弱める案（例: 後攻のみ初回ドロー+1、または後攻初期マナ+1を1ターン限定の条件付きに変更）を試す

### 2026-02-20 16:27 シミュレーター再実行 (Phase 8)

**先後補正案（弱化版）:**
- `test_balance_simulator.gd` の `SECOND_PLAYER_STARTING_MANA_BONUS` を `1 -> 0` に変更
- 新規に `SECOND_PLAYER_INITIAL_DRAW_BONUS := 1` を追加
- 後攻のみ、初期手札配布直後に追加ドロー1枚を実施
- 狙い: Phase 7 の「後攻初期マナ+1」よりも緩い補正で、先後差のオーバーシュートを抑える

**シミュレーター結果（100ゲーム×21マッチアップ）:**
| 色 | 勝率 | 勝/試合 |
|---|---:|---:|
| BLUE | 47.5% | 570/1200 |
| GREEN | 45.0% | 540/1200 |
| BLACK | 63.0% | 756/1200 |
| RED | 48.5% | 582/1200 |
| YELLOW | 45.2% | 543/1200 |
| PURPLE | 51.5% | 618/1200 |
| WHITE | 47.2% | 567/1200 |

**バランス指標:**
- 色勝率差: 18.0% ✗（目標15%以内未達）
- 平均先攻有利: +9.2% ✗（目標±8%未達）

**評価:**
- 先後差は Phase 6（+13.4%）→ Phase 8（+9.2%）で改善
- ただし目標の±8%にはまだ 1.2pt 届かず
- 色差は Phase 7（16.1%）からさらに悪化（18.0%）
- 次Phaseでは「後攻補正」と「BLACK過剰勝率」の同時緩和が必要

### 2026-02-20 16:30 シミュレーター再実行 (Phase 9)

**調整案（1案のみ実装）:**
- `card_database.gd` の色別予算補正を更新
  - GREEN: `-2`（据え置き）
  - BLACK: `-2 -> -3`（追加弱体化）
  - PURPLE: `+2`（据え置き）
- 先後補正は Phase 8 を維持
  - `SECOND_PLAYER_STARTING_MANA_BONUS := 0`
  - `SECOND_PLAYER_INITIAL_DRAW_BONUS := 1`
- 狙い: **BLACK過剰勝率の抑制を優先しつつ、先攻有利の同時収束を確認**

**シミュレーター結果（100ゲーム×21マッチアップ）:**
| 色 | 勝率 | 勝/試合 |
|---|---:|---:|
| BLUE | 48.5% | 582/1200 |
| GREEN | 46.7% | 560/1200 |
| BLACK | 61.7% | 740/1200 |
| RED | 46.2% | 555/1200 |
| YELLOW | 45.4% | 545/1200 |
| PURPLE | 53.8% | 646/1200 |
| WHITE | 45.8% | 550/1200 |

**バランス指標:**
- 色勝率差: 16.3% ✗（目標15%以内未達）
- 平均先攻有利: +11.6% ✗（目標±8%未達）

**評価:**
- BLACKは 63.0% → 61.7% まで抑制（-1.3pt）
- ただし色差は 18.0% → 16.3% と改善止まりで未達
- 先後差は +9.2% → +11.6% と悪化
- 次Phaseは「先後補正の再設計（強すぎず弱すぎない中間案）」を優先し、BLACK抑制を維持する必要あり

---
*このドキュメントは調整ごとに追記*

### 2026-02-20 16:33 シミュレーター再実行 (Phase 10)

**調整案（1案のみ実装）:**
- `dice-deck-random/test/unit/test_balance_simulator.gd` に後攻1ターン目限定の一時マナ補正を追加
  - `SECOND_PLAYER_FIRST_TURN_TEMP_MANA_BONUS := 1`
  - 後攻の最初の召喚フェーズのみ `mana_o + 1` を使用可能
  - 余剰分は持ち越さない（`mana_o = min(mana_o, available_mana)`）
- 既存補正は維持
  - 後攻初期ドロー+1（Phase 8）
  - 後攻初期マナ恒久補正なし
  - 色別予算補正（GREEN -2 / BLACK -3 / PURPLE +2）
- 狙い: **先後差+11.6%を±8%へ寄せつつ、BLACK高勝率を維持抑制**

**検証結果（482 tests passed, 0 failed）:**
- BLUE: 49.3% (592/1200)
- GREEN: 44.7% (536/1200)
- BLACK: 59.3% (712/1200)
- RED: 47.5% (570/1200)
- YELLOW: 48.6% (583/1200)
- PURPLE: 52.5% (630/1200)
- WHITE: 45.3% (544/1200)

**バランス指標:**
- 色勝率差: 14.7% ✓（目標15%以内達成）
- 平均先攻有利: -9.4% ✗（後攻有利へ反転、目標±8%未達）

**評価:**
- BLACKは 61.7% → 59.3% まで追加抑制できた
- 色差は 16.3% → 14.7% で基準内に収束
- ただし先後差は +11.6% から -9.4% へオーバーシュート
- 次Phaseは一時マナ補正の強度をさらに弱める中間案（例: 発動確率化/条件付き化）が必要

### 2026-02-20 16:37 シミュレーター再実行 (Phase 11)

**調整案（1案のみ実装）:**
- `dice-deck-random/test/unit/test_balance_simulator.gd` の後攻補正を中間化
  - `SECOND_PLAYER_INITIAL_DRAW_BONUS := 1 -> 0`（後攻初期ドロー補正を解除）
  - `SECOND_PLAYER_FIRST_TURN_TEMP_MANA_BONUS := 1` は維持（後攻1ターン目のみ使い切り一時マナ+1）
- 色別予算補正は維持（GREEN -2 / BLACK -3 / PURPLE +2）
- 狙い: **Phase 10の補正過多（-9.4%）を緩和しつつ、BLACK抑制を維持したまま先後差を±8%以内へ収束**

**検証結果（482 tests passed, 0 failed）:**
- BLUE: 48.8% (585/1200)
- GREEN: 47.6% (571/1200)
- BLACK: 56.9% (683/1200)
- RED: 51.8% (622/1200)
- YELLOW: 47.8% (573/1200)
- PURPLE: 50.1% (601/1200)
- WHITE: 45.3% (544/1200)

**バランス指標:**
- 色勝率差: 11.6% ✓（目標15%以内達成）
- 平均先攻有利: -5.7% ✓（目標±8%以内達成）

**評価:**
- BLACKは 59.3% → 56.9% まで追加抑制
- 先後差は -9.4% → -5.7% に改善し、オーバーシュート解消
- 色差・先後差の両目標を同時達成
